<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Debug Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .log {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .error {
        background: #fee;
        border-left: 4px solid #f00;
      }
      .success {
        background: #efe;
        border-left: 4px solid #0f0;
      }
      .info {
        background: #eef;
        border-left: 4px solid #00f;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h1>üîç WebSocket Debug Test</h1>

    <div>
      <button onclick="testConnection()">Test Connection</button>
      <button onclick="clearLogs()">Clear Logs</button>
      <button onclick="disconnect()">Disconnect</button>
    </div>

    <div id="logs"></div>

    <script>
      let ws = null;
      let connectionCount = 0;

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.createElement('div');
        logDiv.className = `log ${type}`;
        logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        document.getElementById('logs').appendChild(logDiv);
        console.log(`[${timestamp}] ${message}`);
      }

      function clearLogs() {
        document.getElementById('logs').innerHTML = '';
      }

      function disconnect() {
        if (ws) {
          ws.close(1000, 'Manual disconnect');
          ws = null;
        }
      }

      function testConnection() {
        connectionCount++;
        const clientId = `debug-client-${connectionCount}`;
        const wsUrl = `ws://127.0.0.1:8000/ws/${clientId}`;

        log(`üîÑ Attempting connection to: ${wsUrl}`, 'info');

        try {
          ws = new WebSocket(wsUrl);

          ws.onopen = function (event) {
            log(`‚úÖ Connected successfully as ${clientId}`, 'success');

            // Send a test message
            setTimeout(() => {
              if (ws && ws.readyState === WebSocket.OPEN) {
                const testMessage = {
                  type: 'test',
                  message: 'Hello from debug client',
                  client_id: clientId,
                  timestamp: new Date().toISOString(),
                };
                ws.send(JSON.stringify(testMessage));
                log(
                  `üì§ Sent test message: ${JSON.stringify(testMessage)}`,
                  'info'
                );
              }
            }, 1000);
          };

          ws.onmessage = function (event) {
            log(`üì• Received message: ${event.data}`, 'success');
          };

          ws.onclose = function (event) {
            log(
              `‚ùå Connection closed - Code: ${event.code}, Reason: "${event.reason}", Clean: ${event.wasClean}`,
              'error'
            );

            if (event.code === 1000) {
              log(`‚ÑπÔ∏è Clean close (normal)`, 'info');
            } else if (event.code === 1006) {
              log(`‚ö†Ô∏è Abnormal close (connection lost)`, 'error');
            } else {
              log(`‚ö†Ô∏è Unexpected close code: ${event.code}`, 'error');
            }
          };

          ws.onerror = function (error) {
            log(`üí• WebSocket error: ${error}`, 'error');
          };
        } catch (error) {
          log(`üí• Failed to create WebSocket: ${error.message}`, 'error');
        }
      }

      // Auto-test on page load
      window.onload = function () {
        log('üöÄ WebSocket Debug Tool Ready', 'info');
        log('Click "Test Connection" to start debugging', 'info');
      };
    </script>
  </body>
</html>
